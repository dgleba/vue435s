<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

	<title>How to display a &quot;new version available&quot; of your Progressive Web App</title>

	<meta name="HandheldFriendly" content="True"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link rel="stylesheet" type="text/css" href="/assets/css/A.style.css,qv=f1f29a67d7.pagespeed.cf.433oa9SiA7.css"/>
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
	<!-- Adress bar styling -->
	<meta name="theme-color" content="#000">
	<meta name="msapplication-navbutton-color" content="#000">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="description" content="In this article, I&#x27;ll show you how to add a notification to your site and display it each time that there is a new version of a service worker available."/>
    <link rel="shortcut icon" href="/xfavicon.png.pagespeed.ic.2-iE9MF8Xo.webp" type="image/png"/>
    <link rel="canonical" href="https://deanhume.com/displaying-a-new-version-available-progressive-web-app/" />
    <meta name="referrer" content="no-referrer-when-downgrade"/>
    
    <meta property="og:site_name" content="Dean Hume&#x27;s Blog"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="How to display a &quot;new version available&quot; of your Progressive Web App"/>
    <meta property="og:description" content="In this article, I will show you how to add a notification to your site and display it each time that there is a new version of the service worker available. You’ll also learn how to refresh the page, so that the user is up to date and has the latest version of any cached files."/>
    <meta property="og:url" content="http://deanhume.com/displaying-a-new-version-available-progressive-web-app/"/>
    <meta property="article:published_time" content="2018-05-16T12:49:31.000Z"/>
    <meta property="article:modified_time" content="2018-05-22T09:55:01.000Z"/>
    <meta property="article:tag" content="Progressive Web Apps"/>
    <meta property="article:tag" content="Web Performance"/>
    <meta property="article:tag" content="JavaScript"/>
    <meta property="article:tag" content="Service Workers"/>
    <meta property="article:tag" content="Google Chrome"/>
    <meta property="article:tag" content="Chrome"/>
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="How to display a &quot;new version available&quot; of your Progressive Web App"/>
    <meta name="twitter:description" content="In this article, I will show you how to add a notification to your site and display it each time that there is a new version of the service worker available. You’ll also learn how to refresh the page, so that the user is up to date and has the latest version of any cached files."/>
    <meta name="twitter:url" content="http://deanhume.com/displaying-a-new-version-available-progressive-web-app/"/>
    <meta name="twitter:label1" content="Written by"/>
    <meta name="twitter:data1" content="Dean Hume"/>
    <meta name="twitter:label2" content="Filed under"/>
    <meta name="twitter:data2" content="Progressive Web Apps, Web Performance, JavaScript, Service Workers, Google Chrome, Chrome"/>
    <meta name="twitter:site" content="@DeanoHume"/>
    <meta name="twitter:creator" content="@deanohume"/>
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Dean Hume&#x27;s Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "http://deanhume.com/favicon.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Dean Hume",
        "url": "https://deanhume.com/author/deanhume/",
        "sameAs": [
            "https://deanhume.com",
            "https://twitter.com/deanohume"
        ]
    },
    "headline": "How to display a &quot;new version available&quot; of your Progressive Web App",
    "url": "https://deanhume.com/displaying-a-new-version-available-progressive-web-app/",
    "datePublished": "2018-05-16T12:49:31.000Z",
    "dateModified": "2018-05-22T09:55:01.000Z",
    "keywords": "Progressive Web Apps, Web Performance, JavaScript, Service Workers, Google Chrome, Chrome",
    "description": "In this article, I will show you how to add a notification to your site and display it each time that there is a new version of the service worker available. You’ll also learn how to refresh the page, so that the user is up to date and has the latest version of any cached files.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://deanhume.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.1"/>
    <link rel="alternate" type="application/rss+xml" title="Dean Hume&#x27;s Blog" href="https://deanhume.com/rss/"/>
    <link rel="manifest" href="/manifest.json">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11951201-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-11951201-1');</script>
</head>

<body class="post-template tag-progressive-web-apps tag-web-performance tag-javascript tag-service-workers tag-google-chrome tag-chrome">

	<nav id="menu">
	<a class="close-button">Close</a>
	<div class="nav-wrapper">
		<p class="nav-label">Menu</p>
		<ul>
			<li class="nav-home" role="presentation"><a href="https://deanhume.com/">Home</a></li>
			<li class="nav-about" role="presentation"><a href="https://deanhume.com/about/">About</a></li>
			<li class="nav-progressive-web-apps" role="presentation"><a href="https://deanhume.com/tag/progressive-web-apps/">Progressive Web Apps</a></li>
			<li class="nav-web-performance" role="presentation"><a href="https://deanhume.com/tag/web-performance/">Web Performance</a></li>
			<li class="nav-rss"><a href="https://feeds.feedburner.com/DeanHumesBlog"><i class="ic ic-rss"></i> Subscribe</a></li>
		</ul>
	</div>
</nav>

	<section id="wrapper">
		<a class="hidden-close"></a>
		

<div class="progress-container">
	<span class="progress-bar"></span>
</div>

<header id="post-header">
	<div class="inner">
		<nav id="navigation">
			<span id="home-button" class="nav-button">
				<a class="home-button" href="/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
			</span>
			<span id="menu-button" class="nav-button">
				<a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
			</span>
		</nav>
		<h1 class="post-title">How to display a &quot;new version available&quot; for a Progressive Web App</h1>
		<span class="post-meta"><time datetime="2018-05-16">16 May 2018</time></span>
		
	</div>
</header>

<main class="content" role="main">
	<article class="post tag-progressive-web-apps tag-web-performance tag-javascript tag-service-workers tag-google-chrome tag-chrome">
		<div class="inner">

			<section class="post-content">
				<p>Have you ever been on a website and noticed a popup notification that suggests that there is a new version of the site available? I recently visited Google’s Inbox and noticed a notification a little like the image below.</p>
<p><img src="/content/images/2018/05/xnew-version-available.PNG.pagespeed.ic.fFI6nWRW9t.webp" alt="New version available - Progressive Web App"></p>
<p>I’ve built a number of Progressive Web Apps that simply update the service worker silently for the user in the background, but I really like this approach - especially for an offline first web app. If you’ve ever tried to build a web application that is completely offline first, you’ll know how tricky it can be to make changes to the users cache when you do make updates to the site and the user has connectivity. This is where a pop up notification like Google’s Inbox provides the user with a means of always having the latest version of cached resources. It got me wondering how I could build something a little similar and it turns out that it is a little tricker than it seems - but it is not impossible!</p>
<p>In this article, I will show you how to add a notification to your site and display it each time that there is a new version of the service worker available. You’ll also learn how to refresh the page, so that the user is up to date and has the latest version of any cached files. This article is a bit of a lengthy beast, so strap in tight and get comfy!</p>
<h2 id="gettingstarted">Getting started</h2>
<p>In this example, I am going to use a very basic web page that consists of three assets:</p>
<ul>
<li>index.html</li>
<li>dog.jpg</li>
<li>service-worker.js</li>
</ul>
<p>To start off with, the HTML for my web page looks a little like the following code.</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;title&gt;PWA - New Service Worker available&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;img src=&quot;./dog-face.jpg&quot; /&gt;
  &lt;!-- The notification that will pop up --&gt;
  &lt;div id=&quot;notification&quot;&gt;A new version of this app is available. Click &lt;a id=&quot;reload&quot;&gt;here&lt;/a&gt; to update.&lt;/div&gt;
&lt;/body&gt;
&lt;script&gt;

 if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }).catch(function(err) {
          // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
      }

&lt;/script&gt;
&lt;/html&gt;
</code></pre>
<p>In the web page above, you may notice that I’ve added standard boilerplate code for a web page and the registering of a service worker. Let’s add a bit of service worker magic! Next, create a file and call it <strong>service-worker.js</strong> and add the following code:</p>
<pre><code>const cacheName = ‘firstVersion';

self.addEventListener('install', event =&gt; {
  event.waitUntil(
    caches.open(cacheName)
      .then(cache =&gt; cache.addAll([
        './dog.jpg'
      ]))
  );
});

self.addEventListener('fetch', function (event) {
  event.respondWith(
    caches.match(event.request)
      .then(function (response) {
        if (response) {
          return response;
        }
        return fetch(event.request);
      })
  );
});
</code></pre>
<p>In the code above, we have added basic caching functionality to our service worker. Once the service worker has been installed and each time a user makes the request for the <em>dog.jpg</em> image, it will retrieve it from cache and instantly display it to the user. If you aren’t familiar with the code above, I recommend checking out <a href="https://developers.google.com/web/ilt/pwa/caching-files-with-service-worker">this article</a> for more information - it will take you through the basics and help you understand how service worker caching fits in.</p>
<p>At this point in time, if we fire up the web page it will look a little something like the image below.</p>
<p><img src="/content/images/2018/05/xservice-worker-update-screenshot.png.pagespeed.ic.75j93q49Xr.webp" alt="Service Worker Update Screenshot"></p>
<p>So far so good, but we have a web page that doesn’t really do a whole lot! In order to complete the pieces of the puzzle, we need to update our code so that it notifies the user when there has been a change to the service worker itself. Before we dive any deeper, let’s take a look at the basic flow that needs to take place.</p>
<p><img src="/content/images/2018/05/xpwa-update-available.jpg.pagespeed.ic.NyIiOGoX1a.webp" alt="New version available diagram - Progressive Web App"></p>
<p>In the diagram above, you may notice that a number of steps need to take place before we have a finished product. Firstly, the browser checks to see if there has been an update to the service worker file. If there is an update available, then we show a notification on the screen, else we do nothing. When the user clicks on the notification, we then post a message to the service worker and tell it to skip waiting and become the active service worker. Once that is complete, we then reload the page and our new service worker is in control. Hooray!</p>
<p>While it may seem confusing at first, by the end of this article the above flow will make a bit more sense. Let’s take what we’ve learnt from the flow above and apply the code changes to our web page. We are going to be making the changes below to our <strong>index.html</strong> file.</p>
<pre><code>  let newWorker;

  // The click event on the notification
  document.getElementById('reload').addEventListener('click', function(){
    newWorker.postMessage({ action: 'skipWaiting' });
  });

  if ('serviceWorker' in navigator) {
    // Register the service worker
    navigator.serviceWorker.register('/service-worker.js').then(reg =&gt; {
      reg.addEventListener('updatefound', () =&gt; {

        // An updated service worker has appeared in reg.installing!
        newWorker = reg.installing;

        newWorker.addEventListener('statechange', () =&gt; {

          // Has service worker state changed?
          switch (newWorker.state) {
            case 'installed':

	// There is a new service worker available, show the notification
              if (navigator.serviceWorker.controller) {
                let notification = document.getElementById('notification ');
    notification .className = 'show';
              }

              break;
          }
        });
      });
    });

  }
</code></pre>
<p>Woah - that code has grown a lot on our index.html page! Let’s break it down step by step in order to get a better understanding of the flow.</p>
<p>Once we’ve registered the service worker, we then add an eventListener to the <em>updateFound</em> event. This event is fired any time the ServiceWorkerRegistration.installing property acquires a new service worker. This will determine if there have been any changes to the service worker file and occurs when the user reloads or returns to the web page. The browser has a handy way of checking the contents of the service-worker.js file, and even if it has only changed by one byte, it will treat it as a new version.</p>
<p>If a new version is discovered, the <em>updateFound</em> event will be fired. If this event is fired, we then need to check if a new service worker has been acquired and assign it to a new variable as we will be using this at a later stage.</p>
<p>Now that we have determined that there is a new service worker waiting to be installed, we can then display a notification at the bottom of our page notifying the user that there is a new version available.</p>
<p><img src="/content/images/2018/05/xnew-version-available-notification.png.pagespeed.ic.BZIKHpqQau.webp" alt="New version available notification - Progressive Web App"></p>
<p>If you remember the diagram earlier in this article, you’ll remember that we still need to complete steps 3 &amp; 4 in order for our new service worker to start controlling the page. For step 3, we need to add functionality to the popup notification, so that when the user clicks update, we send a <em>postMessage()</em> to our service worker and tell it to skip the waiting phase. Remember that you can’t communicate directly with a service worker from the client, we need to use the <em>postMessage()</em> method to send a message to a client (a Window, Worker, or SharedWorker). The message is received in the &quot;message&quot; event on navigator.serviceWorker.</p>
<p>The code inside the <strong>service-worker.js</strong> file should be updated to respond to the <em>message</em> event.</p>
<pre><code>self.addEventListener('message', function (event) {
  if (event.data.action === 'skipWaiting') {
    self.skipWaiting();
  }
});
</code></pre>
<p>We are almost there! In our fourth and final step, we need our web page to reload and activate the new service worker. To do this, we need to update the <strong>index.html</strong> page and reload the page as soon as the <em>controllerchange</em> event is fired.</p>
<pre><code>   let refreshing;
   // The event listener that is fired when the service worker updates
   // Here we reload the page
    navigator.serviceWorker.addEventListener('controllerchange', function () {
      if (refreshing) return;
      window.location.reload();
      refreshing = true;
    });
</code></pre>
<p>That’s it - you now have a fully working example!</p>
<h2 id="theresult">The result</h2>
<p>In order to test this in action, I fired this up against my localhost and navigated to the <strong>index.html</strong> page. I find it really easy to test my service worker code using Google Chrome and it’s Developer Tools. If you fire them up and head over to the <strong>Application</strong> tab and with the <strong>Service Workers</strong> menu option selected, you should notice your service worker is installed for the current page.</p>
<p>This is as we expect, the service is installed and controlling the page. Each time we refresh the page, we will retrieve the dog image from cache instead of the network. In order to simulate an update to our service worker, I am going to make a slight change to the <em>service-worker.js</em> file.</p>
<pre><code>const cacheName = ‘secondVersion';
</code></pre>
<p>In the code above, I have simply updated the name of the cache to <em>secondVersion</em>. This small change will let the browser know that we have a new service worker ready to rock and roll. If I refresh the page, I will now get prompted with the popup notifying me that there is a newer version available. Using Chrome Developer tools, I can see the new service worker is waiting to be activated; notice the <strong>Status</strong> section now has two versions, each with a different status.</p>
<p><img src="/content/images/2018/05/xservice-worker-waiting.png.pagespeed.ic.O_HnoiSiXY.webp" alt="Service Worker waiting - Chrome Developer Tools"></p>
<p>If you click the refresh link on the notification bar on our web page, the new service worker will now be installed and controlling the page. You can verify this by opening up the developer tools and heading over to the <strong>Application</strong> tab. You should notice the new service worker is installed and controlling the current page. You can see this in the image below by referring to the version number under the <strong>Status</strong> section.</p>
<p><img src="/content/images/2018/05/xservice-worker-installed.png.pagespeed.ic.sTFZpdnV5Q.webp" alt="Service Worker Installed - Chrome Developer Tools"></p>
<h2 id="conclusion">Conclusion</h2>
<p>Using a technique like this notification is a great way to ensure that you keep your Progressive Web App lightning fast and retain all of the magic of service worker caching, while at the same time keeping the latest version of your service worker live!</p>
<p>If you’d like to see the full working code for this example, please head over to the repo at <a href="https://github.com/deanhume/pwa-update-available">github.com/deanhume/pwa-update-available</a>.</p>
<p>I have to admit, it took me a while to figure all of this out, and I couldn’t have done so without the following articles. I highly recommend reading them to learn more.</p>
<ul>
<li><a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle#skip_waiting">Service Worker Lifecycle</a></li>
<li><a href="https://medium.com/progressive-web-apps/pwa-create-a-new-update-available-notification-using-service-workers-18be9168d717">PWA Update Notification</a></li>
<li><a href="https://stackoverflow.com/questions/40100922/activate-updated-service-worker-on-refresh">StackOverflow</a></li>
</ul>

			</section>

			<section class="post-info">

				<aside class="post-tags">
					<a href="/tag/progressive-web-apps/">Progressive Web Apps</a> <a href="/tag/web-performance/">Web Performance</a> <a href="/tag/javascript/">JavaScript</a> <a href="/tag/service-workers/">Service Workers</a> <a href="/tag/google-chrome/">Google Chrome</a> <a href="/tag/chrome/">Chrome</a>
				</aside>

				<div class="clear"></div>
			</section>

			<aside class="post-nav">
					<a class="post-nav-next" href="/progressive-web-apps-book-giveaway-results/">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-left"></i>
							<h2 class="post-nav-title">Progressive Web Apps - Book Giveaway - Results</h2>
							<p class="post-nav-excerpt">Firstly, I'd like to say a massive thank you to everyone who&hellip;</p>
						</section>
					</a>
					<a class="post-nav-prev" href="/progressive-web-apps-book-giveaway/">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-right"></i>
							<h2 class="post-nav-title">Progressive Web Apps - Book Giveaway</h2>
							<p class="post-nav-excerpt">"Progressive Web Apps" has recently been released, and if you haven't already gotten your hands on a copy, I have 5 free copies to give away to lucky readers.&hellip;</p>
						</section>
					</a>
				<div class="clear"></div>
			</aside>


		</div>
	</article>
</main>


		<div id="body-class" style="display: none;" class="post-template tag-progressive-web-apps tag-web-performance tag-javascript tag-service-workers tag-google-chrome tag-chrome"></div>

	</section>

	<script type="text/javascript" src="/assets/js/script.js?v=f1f29a67d7"></script> <script>function getServiceWorkerStatus(){if('serviceWorker'in navigator){return navigator.serviceWorker.controller?'controlled':'supported';}else{return'unsupported';}}gtag('event','service-worker-support',{'event_category':'service-worker-support','event_label':getServiceWorkerStatus()});if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw-8.js');});}</script>

</body>

</html>